name: Deploy to Preview (Staging)

# DEPLOYMENT WORKFLOW:
# - Push to 'preview' branch → Auto-deploy to staging.tsh.sale
# - Push to 'main' branch → NO auto-deploy (production is MANUAL ONLY)
#
# CRITICAL: This workflow ONLY deploys to PREVIEW environment
# Production deployment is FORBIDDEN via GitHub Actions
# User must manually deploy to production via Vercel Dashboard

on:
  push:
    branches:
      - preview  # ONLY preview branch triggers deployment

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Preview (NOT Production)
        id: deploy
        run: |
          # Deploy and capture both URL and inspect output
          url=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "preview_url=$url" >> $GITHUB_OUTPUT
          echo "Deployed to: $url"

          # Get deployment ID using vercel inspect
          DEPLOY_INFO=$(vercel inspect "$url" --token=${{ secrets.VERCEL_TOKEN }} 2>&1 || true)
          DEPLOY_ID=$(echo "$DEPLOY_INFO" | grep -oP 'dpl_[a-zA-Z0-9]+' | head -1)
          echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
          echo "Deployment ID: $DEPLOY_ID"

      - name: Alias to staging.tsh.sale
        run: |
          DEPLOY_ID="${{ steps.deploy.outputs.deploy_id }}"
          echo "Using Deployment ID: $DEPLOY_ID"

          if [ -z "$DEPLOY_ID" ] || [ "$DEPLOY_ID" = "null" ]; then
            echo "Warning: No deployment ID found, trying to get from recent deployments..."
            # Fallback: Get most recent deployment from API
            DEPLOY_ID=$(curl -s -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
              "https://api.vercel.com/v6/deployments?teamId=${{ secrets.VERCEL_ORG_ID }}&projectId=${{ secrets.VERCEL_PROJECT_ID }}&limit=1" \
              | jq -r '.deployments[0].uid')
            echo "Found deployment ID: $DEPLOY_ID"
          fi

          # Create alias via API
          ALIAS_RESULT=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"alias":"staging.tsh.sale"}' \
            "https://api.vercel.com/v2/deployments/$DEPLOY_ID/aliases?teamId=${{ secrets.VERCEL_ORG_ID }}")

          echo "Alias result: $ALIAS_RESULT"

          # Check if successful
          if echo "$ALIAS_RESULT" | jq -e '.uid' > /dev/null 2>&1; then
            echo "Successfully aliased to: https://staging.tsh.sale"
          elif echo "$ALIAS_RESULT" | jq -e '.error.code == "not_modified"' > /dev/null 2>&1; then
            echo "Alias already set to: https://staging.tsh.sale"
          else
            echo "Warning: Alias may have failed. Check Vercel dashboard."
          fi

      - name: Deployment Summary
        run: |
          echo "## Preview Deployment Complete"
          echo ""
          echo "Preview URL: ${{ steps.deploy.outputs.preview_url }}"
          echo "Staging URL: https://staging.tsh.sale"
          echo ""
          echo "Production deployment is MANUAL ONLY via Vercel Dashboard."
